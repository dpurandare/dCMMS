# Flink Configuration for dCMMS Telemetry Pipeline (DCMMS-057)
# Optimized for production-scale throughput (72K events/sec target)

##############################################################################
# JOB MANAGER CONFIGURATION
##############################################################################

jobmanager.rpc.address: localhost
jobmanager.rpc.port: 6123
jobmanager.memory.process.size: 2048m
jobmanager.memory.flink.size: 1600m
jobmanager.memory.jvm-overhead.min: 192m
jobmanager.memory.jvm-overhead.max: 384m

##############################################################################
# TASK MANAGER CONFIGURATION
##############################################################################

# Production: 8 TaskManagers x 4 slots = 32 parallelism
# Local: 2 TaskManagers x 4 slots = 8 parallelism
taskmanager.numberOfTaskSlots: 4

# Memory configuration (per TaskManager)
# Production: 8GB per TaskManager (scale horizontally)
# Local: 2GB per TaskManager
taskmanager.memory.process.size: 2048m
taskmanager.memory.flink.size: 1600m
taskmanager.memory.managed.size: 1024m  # For RocksDB state backend
taskmanager.memory.jvm-overhead.min: 192m
taskmanager.memory.jvm-overhead.max: 384m

# Network buffers (critical for high throughput)
# Each buffer is 32KB, increase for high-volume streams
taskmanager.memory.network.min: 256m
taskmanager.memory.network.max: 512m
taskmanager.network.numberOfBuffers: 8192

##############################################################################
# CHECKPOINTING & STATE BACKEND
##############################################################################

# State backend: RocksDB (for large state)
state.backend: rocksdb
state.backend.incremental: true
state.backend.rocksdb.localdir: /tmp/flink-rocksdb
state.backend.rocksdb.predefined-options: SPINNING_DISK_OPTIMIZED_HIGH_MEM

# Checkpoint storage
state.checkpoints.dir: file:///tmp/flink-checkpoints
state.savepoints.dir: file:///tmp/flink-savepoints

# Checkpoint configuration
execution.checkpointing.interval: 30s
execution.checkpointing.mode: EXACTLY_ONCE
execution.checkpointing.timeout: 10min
execution.checkpointing.max-concurrent-checkpoints: 2
execution.checkpointing.min-pause: 10s
execution.checkpointing.tolerable-failed-checkpoints: 3

# Externalize checkpoints (keep on cancellation)
execution.checkpointing.externalized-checkpoint-retention: RETAIN_ON_CANCELLATION

##############################################################################
# RESTART STRATEGY
##############################################################################

restart-strategy: fixed-delay
restart-strategy.fixed-delay.attempts: 10
restart-strategy.fixed-delay.delay: 30s

##############################################################################
# PARALLELISM & EXECUTION
##############################################################################

# Default parallelism (can be overridden per job)
parallelism.default: 8

# Allow higher parallelism for production
akka.framesize: 104857600b  # 100MB (for large messages)

##############################################################################
# METRICS & MONITORING
##############################################################################

# Metrics reporters
metrics.reporters: prom
metrics.reporter.prom.factory.class: org.apache.flink.metrics.prometheus.PrometheusReporterFactory
metrics.reporter.prom.port: 9249-9250

# Enable latency tracking
metrics.latency.interval: 5000
metrics.latency.granularity: operator
metrics.latency.history-size: 128

# System metrics
metrics.system-resource: true
metrics.system-resource-probing-interval: 10000

##############################################################################
# BACKPRESSURE & FLOW CONTROL
##############################################################################

# Watermark alignment (prevent backpressure from slow partitions)
pipeline.watermark-alignment.enabled: true
pipeline.watermark-alignment.max-drift: 5s

# Network buffer timeout (flush partial buffers)
taskmanager.network.memory.buffer-debloat.enabled: true
taskmanager.network.memory.buffer-debloat.period: 200ms

##############################################################################
# HIGH AVAILABILITY (Optional - for production)
##############################################################################

# Uncomment for HA setup with Zookeeper/Kubernetes
# high-availability: zookeeper
# high-availability.zookeeper.quorum: localhost:2181
# high-availability.zookeeper.path.root: /flink
# high-availability.cluster-id: /dcmms-telemetry
# high-availability.storageDir: file:///tmp/flink-ha

##############################################################################
# PERFORMANCE TUNING
##############################################################################

# Async I/O for external calls (e.g., PostgreSQL enrichment)
async.operations.maximum-size: 100
async.operations.timeout: 30s

# Chaining optimization (combine operators)
pipeline.operator-chaining: true

# Object reuse (reduce GC pressure)
pipeline.object-reuse: true

# Buffer timeout (trade latency for throughput)
execution.buffer-timeout: 100ms

##############################################################################
# JVM OPTIONS
##############################################################################

# GC tuning for low-latency (G1GC)
env.java.opts: -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=4 -XX:ConcGCThreads=2

# JVM heap dump on OOM
env.java.opts.jobmanager: -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/flink-jm-heap-dump.hprof
env.java.opts.taskmanager: -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/tmp/flink-tm-heap-dump.hprof

##############################################################################
# RESOURCE PROVIDER (for Kubernetes/YARN)
##############################################################################

# Kubernetes-specific configuration (if deploying to K8s)
# kubernetes.cluster-id: dcmms-telemetry
# kubernetes.namespace: dcmms
# kubernetes.container.image: flink:1.18-scala_2.12-java11
